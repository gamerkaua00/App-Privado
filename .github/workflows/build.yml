name: Build Android APK (GhostMsg Fixed)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do Código
        uses: actions/checkout@v3

      - name: Setup Node.js 18
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Setup Java 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Instalar Cordova
        run: npm install -g cordova

      # --- CRIAÇÃO ESTRUTURADA (IGUAL ELETRO NIC) ---
      - name: Criar App Cordova
        run: |
          # 1. Cria o projeto base
          cordova create temp_app com.kaua.messenger "GhostMsg"
          
          # 2. Entra na pasta
          cd temp_app
          
          # 3. Adiciona Android
          cordova platform add android

      - name: Injetar Código e Configurações
        run: |
          echo "--- Copiando seus arquivos da pasta www ---"
          # Limpa a pasta www padrão do cordova
          rm -rf temp_app/www/*
          # Copia o seu site para dentro
          cp -r www/* temp_app/www/
          
          # Copia o ícone se existir
          if [ -f "icon.png" ]; then
            echo "Ícone encontrado!"
            cp icon.png temp_app/www/icon.png
          fi

          echo "--- Configurando config.xml (Estilo EletroNIC) ---"
          # Aqui usamos o comando SED para editar o arquivo igual ao seu outro projeto
          # Isso garante que o Cordova não se perca
          
          cd temp_app
          
          # Remove Splash Screen
          sed -i '/<\/widget>/i \    <preference name="ShowSplashScreen" value="false" />' config.xml
          sed -i '/<\/widget>/i \    <preference name="SplashScreenDelay" value="0" />' config.xml
          sed -i '/<\/widget>/i \    <preference name="FadeSplashScreen" value="false" />' config.xml
          
          # Configura cor de fundo (Dark)
          sed -i '/<\/widget>/i \    <preference name="BackgroundColor" value="0xff0d1117" />' config.xml
          sed -i '/<\/widget>/i \    <preference name="AndroidWindowSplashScreenBackground" value="#0d1117" />' config.xml

          # Configura Ícone no XML
          sed -i '/<\/widget>/i \    <icon src="www/icon.png" />' config.xml

      - name: Build APK (Debug)
        run: |
          cd temp_app
          # Usamos DEBUG para não precisar de chaves secretas agora
          cordova build android --debug -- --packageType=apk

      - name: Upload do APK
        uses: actions/upload-artifact@v4
        with:
          name: GhostMsg-App
          # O asterisco duplo garante que ele ache o APK onde quer que esteja
          path: temp_app/**/*.apk
